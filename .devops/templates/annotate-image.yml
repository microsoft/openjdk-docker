parameters:
  - name: registry
    type: string
  - name: organization
    type: string
  - name: feed
    type: string
  - name: package
    type: string
  - name: dryrun
    type: boolean
    default: false
  - name: references
    type: object

steps:
  - task: AzureCLI@2
    displayName: Download ORAS
    condition: eq(variables['hasExistingImages'], 'true')
    inputs:
      azureSubscription: "JEG-Infrastructure"
      scriptType: "bash"
      scriptLocation: "scriptPath"
      scriptPath: $(Build.SourcesDirectory)/scripts/install-oras.sh
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
      ORAS_VERSION: 1.1.0
      ORGANIZATION: ${{ parameters.organization }}
      FEED: ${{ parameters.feed }}
      NAME: ${{ parameters.package }}

  ${{ each reference in parameters.references }}:
  - task: AzureCLI@2
    displayName: Annotate previous amd64 as EOL
    condition: eq(variables['hasExistingImages'], 'true')
    inputs:
      azureSubscription: "JEG-Infrastructure"
      scriptType: "bash"
      scriptLocation: "scriptPath"
      scriptPath: $(Build.SourcesDirectory)/scripts/image-annotation.sh
      ${{ if eq(parameters.dryrun, true) }}:
        arguments: >
          -r ${{ parameters.registry }}
          -m $(reference)
          -d
      ${{ else }}:
        arguments: >
          -r ${{ parameters.registry }}
          -m $(reference)

  # - task: AzureCLI@2
  #   displayName: Annotate previous arm64 as EOL
  #   condition: eq(variables['hasExistingImages'], 'true')
  #   inputs:
  #     azureSubscription: "JEG-Infrastructure"
  #     scriptType: "bash"
  #     scriptLocation: "scriptPath"
  #     scriptPath: $(Build.SourcesDirectory)/scripts/image-annotation.sh
  #     ${{ if eq(parameters.dryrun, true) }}:
  #       arguments: >
  #         -r ${{ parameters.registry }}
  #         -m $(imageDigestArm64)
  #         -d
  #     ${{ else }}:
  #       arguments: >
  #         -r ${{ parameters.registry }}
  #         -m $(imageDigestArm64)